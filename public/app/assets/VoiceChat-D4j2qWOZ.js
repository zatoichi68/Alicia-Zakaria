import{c as le,r,u as ue,R as Z,j as e,M as de}from"./index-BVaTGwHT.js";import{X as ce}from"./x-CnEyUCPP.js";/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=[["path",{d:"M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2",key:"169zse"}]],me=le("activity",fe);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=[["path",{d:"M12 19v3",key:"npa21l"}],["path",{d:"M15 9.34V5a3 3 0 0 0-5.68-1.33",key:"1gzdoj"}],["path",{d:"M16.95 16.95A7 7 0 0 1 5 12v-2",key:"cqa7eg"}],["path",{d:"M18.89 13.23A7 7 0 0 0 19 12v-2",key:"16hl24"}],["path",{d:"m2 2 20 20",key:"1ooewy"}],["path",{d:"M9 9v3a3 3 0 0 0 5.12 2.12",key:"r2i35w"}]],pe=le("mic-off",he);function xe(o){const u=atob(o),l=u.length,n=new Uint8Array(l);for(let i=0;i<l;i++)n[i]=u.charCodeAt(i);return n}async function be(o,u,l,n){const i=new Int16Array(o.buffer),T=i.length/n,s=u.createBuffer(n,T,l);for(let k=0;k<n;k++){const S=s.getChannelData(k);for(let p=0;p<T;p++)S[p]=i[p*n+k]/32768}return s}function ge(o){const u=new ArrayBuffer(o.length*2),l=new Int16Array(u);for(let n=0;n<o.length;n++){const i=Math.max(-1,Math.min(1,o[n]));l[n]=i<0?i*32768:i*32767}return u}const we=o=>o.startsWith("wss://")||o.startsWith("ws://")?o:o.startsWith("https://")?o.replace("https://","wss://"):o.startsWith("http://")?o.replace("http://","ws://"):o,ie=(o,u)=>{const l=o.includes("?")?"&":"?",n=new URLSearchParams(u).toString();return`${o}${l}${n}`},ye=o=>{const u="https://voice-proxy-417768250731.us-central1.run.app";if(u.trim())return ie(we(u.trim()),{token:o});const l=window.location.protocol==="https:"?"wss":"ws";return ie(`${l}://${window.location.host}/voice`,{token:o})},ve=({onConnectionStateChange:o,onError:u,persona:l="alicia",language:n="fr",accessCode:i,memoryConsent:T,onCallProche:s})=>{const[k,S]=r.useState(!1),[p,V]=r.useState(!1),g=r.useRef(!1),[K,R]=r.useState(0),C=r.useRef(o),N=r.useRef(u),z=r.useRef(s);r.useEffect(()=>{C.current=o,N.current=u,z.current=s},[o,u,s]);const d=r.useRef(null),w=r.useRef(null),x=r.useRef(null),A=r.useRef(null),L=r.useRef(null),J=r.useRef(null),j=r.useRef(null),m=r.useRef(new Set),M=r.useRef(0),W=r.useRef(!1),D=r.useRef(null),b=r.useRef(null),U=r.useRef(null),q=r.useRef(!1),$=r.useCallback(async()=>{if(!i||!T)return;const t=String(i).trim(),c=sessionStorage.getItem("mvp_first_name")||"";if(t){console.log("üíæ Fallback: Saving default memory entry...");try{await fetch("/api/memory/set",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({accessCode:t,summary:n==="en"?"Conversation ended by the user.":"Conversation termin√©e par l'utilisateur.",profileName:c,persona:l})}),console.log("‚úÖ Fallback save completed")}catch(h){console.error("‚ùå Fallback save error:",h)}}},[i,T,l,n]),G=r.useCallback(()=>{var t;d.current&&(d.current.close(),d.current=null),J.current&&(cancelAnimationFrame(J.current),J.current=null),A.current&&(A.current.disconnect(),A.current=null),j.current&&(j.current.getTracks().forEach(c=>c.stop()),j.current=null),m.current.forEach(c=>{try{c.stop(),c.disconnect()}catch{}}),m.current.clear(),w.current&&w.current.state!=="closed"&&(w.current.close().catch(()=>{}),w.current=null),x.current&&x.current.state!=="closed"&&(x.current.close().catch(()=>{}),x.current=null),(t=C.current)==null||t.call(C,!1)},[]),E=r.useCallback(async(t=!1)=>{if(t&&d.current&&d.current.readyState===d.current.OPEN&&g.current){if(console.log("üõë Requesting graceful shutdown..."),g.current=!1,j.current&&j.current.getTracks().forEach(h=>h.enabled=!1),A.current)try{A.current.disconnect()}catch{}W.current=!1;const c=n==="en"?"I have to go. Summarize our conversation and end the session.":"Je dois y aller. Fais le r√©sum√© et termine la conversation.";d.current.send(JSON.stringify({type:"text",data:c})),await new Promise(h=>setTimeout(h,8e3)),W.current||(console.log("‚ö†Ô∏è Tool call not received after 4s, using fallback save"),await $())}else!W.current&&g.current&&(console.log("‚ö†Ô∏è Force stop while streaming, attempting fallback save"),await $());g.current=!1,S(!1),V(!1),d.current&&d.current.readyState===d.current.OPEN&&d.current.send(JSON.stringify({type:"stop"})),D.current&&window.clearTimeout(D.current),U.current&&(window.clearTimeout(U.current),U.current=null),D.current=window.setTimeout(()=>{G(),D.current=null},1e3)},[$,G,n]),te=r.useCallback(()=>{var t;S(!1),g.current=!1,(t=C.current)==null||t.call(C,!1)},[]),_=r.useCallback(()=>{if(L.current&&g.current){const t=new Uint8Array(L.current.frequencyBinCount);L.current.getByteTimeDomainData(t);let c=0;for(const h of t){const a=h/128-1;c+=a*a}R(Math.sqrt(c/t.length))}else R(0);J.current=requestAnimationFrame(_)},[]),re=r.useCallback(t=>{d.current&&d.current.readyState===d.current.OPEN&&d.current.send(JSON.stringify({type:"text",data:t}))},[]),H=r.useCallback(async t=>{var c,h,a,f,B;if(t.type==="state"){t.connected||console.warn("üì° WebSocket Disconnected:",{code:t.code,reason:t.reason}),V(!1),S(t.connected),g.current=t.connected,(c=C.current)==null||c.call(C,t.connected);return}if(t.type==="error"){(h=N.current)==null||h.call(N,t.message);return}if(t.type==="interrupted"){m.current.forEach(y=>{try{y.stop(),y.disconnect()}catch{}}),m.current.clear(),M.current=0;return}if(t.type==="audio"&&x.current){try{M.current=Math.max(M.current,x.current.currentTime);const y=await be(xe(t.data),x.current,24e3,1),v=x.current.createBufferSource();v.buffer=y,v.connect(x.current.destination),v.addEventListener("ended",()=>m.current.delete(v)),v.start(M.current),M.current+=y.duration,m.current.add(v)}catch{}return}if(t.type==="functionCall"){if(t.name==="appeler_proche"){const y=(a=t.args)==null?void 0:a.nom;y&&((f=z.current)==null||f.call(z,y));return}if(t.name==="sauvegarder_et_quitter"||t.name==="fin_de_conversation"){console.log("üîß Tool Call Received: "+t.name,t.args),W.current=!0;const y=(B=t.args)==null?void 0:B.resume;if(y&&i&&T){console.log("üíæ Attempting to save memory to Firestore...");const v=String(i).trim(),ee=sessionStorage.getItem("mvp_first_name")||"";v&&fetch("/api/memory/set",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({accessCode:v,summary:y,profileName:ee,persona:l})}).then(Q=>{console.log("‚úÖ Save response status:",Q.status),Q.ok||console.error("‚ùå Save failed")}).catch(Q=>console.error("‚ùå Save error:",Q))}else console.warn("‚ö†Ô∏è Memory not saved: Missing code or consent",{accessCode:i,memoryConsent:T});q.current?window.dispatchEvent(new CustomEvent("session-refreshing")):window.dispatchEvent(new CustomEvent("session-closing")),b.current&&window.clearTimeout(b.current),b.current=window.setTimeout(()=>{const v=q.current;E(),b.current=null,v&&setTimeout(()=>{g.current||p||Y()},1e3)},6e3)}}},[E,i,T,l]),Y=r.useCallback(async()=>{var t;if(!(g.current||p)){q.current=!1,D.current&&(window.clearTimeout(D.current),G(),D.current=null),V(!0),W.current=!1,M.current=0,b.current&&(window.clearTimeout(b.current),b.current=null);try{let c="",h="";const a=String(i||"").trim();if(T){if(!a)throw new Error(n==="en"?"Access code required to load memory.":"Code d'acc√®s requis pour charger la m√©moire.");try{const I=await fetch("/api/memory/get",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({accessCode:a})});if(I.ok){const O=await I.json();h=String(O.profileName||"");const X=(Array.isArray(O.entries)?O.entries:[]).filter(P=>P&&typeof P.summary=="string"&&P.summary.trim()).map(P=>{const oe=P.createdAt?new Date(P.createdAt).toLocaleDateString(n==="en"?"en-CA":"fr-CA"):"";return`- ${oe?`[${oe}] `:""}${String(P.summary).trim()}`});X.length&&(c=n==="en"?`Conversation history (recent):
${X.join(`
`)}`:`Historique des conversations (r√©cent):
${X.join(`
`)}`)}}catch{}}const f=sessionStorage.getItem("mvp_first_name")||"";c=`${n==="en"?`User first name: ${f||h||"User"}.`:`Pr√©nom de l'utilisateur: ${f||h||"Utilisateur"}.`}
${c}`.trim(),console.log("üì° Initializing Voice Session...",{persona:l,accessCode:a,hasMemory:!!c,memoryLength:c.length});const y=window.AudioContext||window.webkitAudioContext;w.current=new y({sampleRate:16e3}),x.current=new y({sampleRate:24e3}),await w.current.resume(),await x.current.resume();const v=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0},video:!1});j.current=v;const ee=await fetch("/api/voice-token",{method:"GET"});if(!ee.ok)throw new Error(n==="en"?"Unable to secure the session.":"Impossible de s√©curiser la session.");const Q=await ee.json(),se=String(Q.token||"");if(!se)throw new Error(n==="en"?"Invalid token.":"Token invalide.");const ne=ye(se);console.log("üîå Connecting to WebSocket:",ne);const F=new WebSocket(ne);d.current=F,F.onmessage=async I=>{console.log("üì© Received WebSocket message:",I.data.toString().substring(0,100));try{const O=JSON.parse(I.data);await H(O)}catch(O){console.error("‚ùå Failed to parse message:",O)}},F.onopen=()=>{console.log("‚úÖ WebSocket opened, sending start message..."),F.send(JSON.stringify({type:"start",persona:l,language:n,memory:c})),U.current&&window.clearTimeout(U.current),U.current=window.setTimeout(async()=>{console.log("üîÑ Session limit approaching, refreshing..."),q.current=!0,await E(!0)},54e4);const I=w.current.createMediaStreamSource(v);L.current=w.current.createAnalyser(),L.current.fftSize=256,I.connect(L.current),A.current=w.current.createScriptProcessor(512,1,1),A.current.onaudioprocess=ae=>{if(!g.current||F.readyState!==F.OPEN)return;const X=ae.inputBuffer.getChannelData(0),P=ge(X);F.send(P)},I.connect(A.current);const O=w.current.createGain();O.gain.value=0,A.current.connect(O),O.connect(w.current.destination),_()},F.onerror=()=>{var I;(I=N.current)==null||I.call(N,n==="en"?"Unable to connect. Please try again.":"Connexion impossible. Veuillez r√©essayer.")},F.onclose=()=>{E()}}catch(c){(t=N.current)==null||t.call(N,(c==null?void 0:c.message)||(n==="en"?"Unable to initialize microphone.":"Impossible d'initialiser le micro.")),E()}}},[H,p,l,E,i,T,n]);return r.useEffect(()=>()=>{E()},[E]),{isStreaming:k,isConnecting:p,startSession:Y,stopSession:E,forceStopUI:te,sendText:re,volumeLevel:K}},je=({onClose:o,persona:u,accessCode:l,memoryConsent:n,onStartCall:i})=>{const{language:T,t:s}=ue(),[k,S]=Z.useState(!1),p=Z.useRef(!1),[V,g]=r.useState(null),[K,R]=r.useState(null),[C,N]=r.useState(!1),[z,d]=r.useState(""),[w,x]=r.useState(""),[A,L]=r.useState(!1),[J,j]=r.useState(!1),m=Z.useRef(null),M=Z.useRef(void 0),W=Z.useCallback(a=>{g(a)},[]),D=Z.useCallback(a=>{a?(p.current=!1,S(!1),g(null),N(!1),j(!1)):p.current||S(!1)},[]),{isStreaming:b,isConnecting:U,startSession:q,stopSession:$,volumeLevel:G}=ve({onError:W,onConnectionStateChange:D,persona:u,language:T,accessCode:l,memoryConsent:n,onCallProche:a=>{var f;return(f=M.current)==null?void 0:f.call(M,a)}});r.useEffect(()=>{M.current=a=>{console.log("üìû IA requested call for:",a);const f=a.replace(/\s+/g,"_").toLowerCase(),B=`AliciaZakaria_${l}_${f}`;$(),i==null||i(B,a)}},[l,$,i]);const E=async()=>{b&&!k?(p.current=!0,S(!0),m.current&&window.clearTimeout(m.current),await $(!0),j(!0),S(!1),p.current=!1,R(s("Session termin√©e.","Session ended."))):b||($(),j(!0))};r.useEffect(()=>{const a=()=>{p.current=!0,S(!0),j(!0),m.current&&window.clearTimeout(m.current),m.current=window.setTimeout(()=>{S(!1),R("Session termin√©e."),p.current=!1},2500)},f=()=>{R(s("Optimisation de la connexion...","Optimizing connection...")),m.current&&window.clearTimeout(m.current),m.current=window.setTimeout(()=>{R(null)},2500)};return window.addEventListener("session-closing",a),window.addEventListener("session-refreshing",f),q(),()=>{$(),window.removeEventListener("session-closing",a),window.removeEventListener("session-refreshing",f),m.current&&window.clearTimeout(m.current)}},[]);const te=async a=>{if(a.preventDefault(),!!z.trim()){L(!0),x("");try{const f=await fetch("/api/search",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:z})});if(!f.ok)throw new Error("Search failed");const B=await f.json();x(B.text||s("Je n'ai pas trouv√© de r√©ponse, d√©sol√©.","I couldn't find an answer, sorry."))}catch{x(s("Une erreur est survenue lors de la recherche. Veuillez r√©essayer.","An error occurred during search. Please try again."))}finally{L(!1)}}},_=u==="alicia",re=_?"bg-teal-100 dark:bg-teal-900 text-teal-800 dark:text-teal-200":"bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200",H=_?"bg-teal-400":"bg-blue-400",Y=_?"bg-gradient-to-br from-teal-400 to-emerald-500":"bg-gradient-to-br from-blue-400 to-indigo-500",t=_?"bg-teal-600 dark:bg-teal-700 text-white hover:bg-teal-700 dark:hover:bg-teal-600":"bg-blue-600 dark:bg-blue-700 text-white hover:bg-blue-700 dark:hover:bg-blue-600",c=async()=>{const a=l.trim();if(a){R(null);try{if(!(await fetch("/api/memory/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({accessCode:a})})).ok)throw new Error("delete failed");R(s("M√©moire effac√©e.","Memory cleared."))}catch{R(s("Impossible d'effacer la m√©moire.","Unable to clear memory."))}}},h=k?s("Fermeture de la session...","Closing session..."):b?s("Parlez-moi de votre journ√©e, ou demandez-moi une histoire.","Tell me about your day, or ask for a story."):U?s("Connexion en cours...","Connecting..."):J?s("Session en pause.","Session paused."):s("Initialisation en cours...","Initializing...");return e.jsxs("div",{className:"h-full flex flex-col items-center justify-between py-8 max-w-2xl mx-auto",children:[e.jsxs("div",{className:"w-full flex justify-between items-center px-4",children:[e.jsxs("div",{className:`${re} px-4 py-2 rounded-full font-medium text-lg transition-colors`,children:[s("En ligne avec","Online with")," ",_?"Alicia":"Zakaria"]}),e.jsx("button",{onClick:o,className:"bg-red-100 dark:bg-red-900/50 p-4 rounded-full text-red-700 dark:text-red-300 hover:bg-red-200 dark:hover:bg-red-900 transition-colors",children:e.jsx(ce,{className:"w-8 h-8"})})]}),e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center gap-8 w-full",children:[V&&e.jsx("div",{className:"w-full px-4",children:e.jsxs("div",{className:"bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-800 rounded-2xl p-4 text-amber-900 dark:text-amber-100",children:[e.jsx("p",{className:"font-bold mb-2",children:s("Microphone indisponible","Microphone unavailable")}),e.jsx("p",{className:"text-sm mb-4",children:V}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>q(),className:"px-4 py-2 rounded-xl bg-amber-600 text-white font-bold hover:bg-amber-700 transition-colors",children:s("R√©essayer","Retry")}),e.jsx("button",{onClick:()=>N(!0),className:"px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 font-bold hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors",children:s("Mode texte","Text mode")})]})]})}),K&&e.jsx("div",{className:"w-full px-4",children:e.jsxs("div",{className:"bg-emerald-50 dark:bg-emerald-900/30 border border-emerald-200 dark:border-emerald-800 rounded-2xl p-4 text-emerald-900 dark:text-emerald-100 flex justify-between items-center",children:[e.jsx("p",{className:"text-sm",children:K}),e.jsx("button",{onClick:()=>R(null),className:"text-emerald-500 hover:text-emerald-600",children:e.jsx(ce,{className:"w-4 h-4"})})]})}),C&&e.jsx("div",{className:"w-full px-4",children:e.jsxs("div",{className:"bg-white dark:bg-slate-900 p-6 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-800 space-y-4",children:[e.jsx("h3",{className:"text-xl font-bold text-slate-800 dark:text-slate-100",children:s("Mode texte","Text mode")}),e.jsxs("form",{onSubmit:te,className:"flex gap-3",children:[e.jsx("input",{type:"text",value:z,onChange:a=>d(a.target.value),placeholder:s("√âcrivez votre message...","Write your message..."),className:"flex-1 bg-slate-50 dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 rounded-2xl px-4 py-3 text-lg text-slate-900 dark:text-slate-100 focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:focus:ring-blue-900/50 outline-none transition-all placeholder:text-slate-400 dark:placeholder:text-slate-500"}),e.jsx("button",{type:"submit",disabled:A||!z.trim(),className:"bg-blue-600 dark:bg-blue-700 text-white px-5 rounded-xl font-bold hover:bg-blue-700 dark:hover:bg-blue-600 disabled:bg-slate-300 dark:disabled:bg-slate-700 disabled:cursor-not-allowed transition-colors",children:s("Envoyer","Send")})]}),A&&e.jsx("p",{className:"text-slate-500",children:s("Recherche en cours...","Searching...")}),w&&e.jsx("p",{className:"text-slate-800 dark:text-slate-200 whitespace-pre-wrap",children:w})]})}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:`absolute inset-0 ${H} rounded-full opacity-20 transition-all duration-75`,style:{transform:`scale(${1+G*3})`}}),e.jsx("div",{className:`absolute inset-0 ${H} rounded-full opacity-20 transition-all duration-100 delay-75`,style:{transform:`scale(${1+G*4})`}}),e.jsx("div",{className:`w-64 h-64 ${Y} rounded-full flex items-center justify-center shadow-xl relative z-10 border-8 border-white dark:border-slate-800 transition-colors`,children:b?e.jsx(me,{className:"w-24 h-24 text-white animate-pulse"}):e.jsx("div",{className:"text-white text-6xl font-bold",children:_?"A":"Z"})})]}),e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("h2",{className:"text-3xl font-bold text-slate-800 dark:text-white",children:k?s("√Ä la prochaine !","See you soon!"):b?s("Je vous √©coute...","I am listening..."):s("En attente...","Waiting...")}),e.jsx("p",{className:"text-xl text-slate-500 dark:text-slate-400",children:h})]})]}),e.jsxs("div",{className:"w-full px-4 pb-8",children:[e.jsxs("div",{className:"flex flex-col items-center gap-6",children:[e.jsxs("div",{className:"flex justify-center gap-6 flex-wrap",children:[b&&e.jsxs("button",{onClick:E,disabled:k,className:"flex items-center gap-4 px-12 py-6 rounded-full text-2xl font-bold shadow-lg transition-all transform active:scale-95 bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-200 border-2 border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 disabled:opacity-50",children:[e.jsx(pe,{className:"w-8 h-8"}),k?s("Fermeture...","Closing..."):s("Arr√™ter","Stop")]}),!b&&J&&e.jsxs("button",{onClick:()=>{g(null),R(null),j(!1),q()},className:`flex items-center gap-4 px-12 py-6 rounded-full text-2xl font-bold shadow-lg transition-all transform active:scale-95 ${t}`,children:[e.jsx(de,{className:"w-8 h-8"}),s("Reprendre","Resume")]})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{onClick:c,className:"flex items-center gap-3 px-6 py-4 rounded-full text-lg font-bold shadow-sm transition-all transform active:scale-95 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 border border-slate-200 dark:border-slate-700 hover:bg-slate-200 dark:hover:bg-slate-700",children:s("Effacer la m√©moire","Clear memory")}),k&&e.jsx("button",{onClick:()=>{$(),j(!0),S(!1)},className:"text-slate-400 hover:text-red-500 text-sm font-medium underline",children:s("Forcer l'arr√™t (sans sauvegarde)","Force stop (without saving)")})]})]}),!n&&e.jsx("p",{className:"mt-4 text-center text-sm text-slate-500 dark:text-slate-400",children:s("La m√©moire est d√©sactiv√©e. Activez-la depuis l‚Äô√©cran d‚Äôacc√®s si vous le souhaitez.","Memory is disabled. Enable it from the access screen if you want.")})]})]})};export{je as VoiceChat};
