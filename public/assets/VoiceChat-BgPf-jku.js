import{c as le,r as t,R as V,j as e,M as ie}from"./index-UcKz3oz6.js";import{X as oe}from"./x-DieIGfBu.js";/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ue=[["path",{d:"M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2",key:"169zse"}]],de=le("activity",ue);/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=[["path",{d:"M12 19v3",key:"npa21l"}],["path",{d:"M15 9.34V5a3 3 0 0 0-5.68-1.33",key:"1gzdoj"}],["path",{d:"M16.95 16.95A7 7 0 0 1 5 12v-2",key:"cqa7eg"}],["path",{d:"M18.89 13.23A7 7 0 0 0 19 12v-2",key:"16hl24"}],["path",{d:"m2 2 20 20",key:"1ooewy"}],["path",{d:"M9 9v3a3 3 0 0 0 5.12 2.12",key:"r2i35w"}]],me=le("mic-off",fe);function he(n){const u=atob(n),l=u.length,a=new Uint8Array(l);for(let c=0;c<l;c++)a[c]=u.charCodeAt(c);return a}async function xe(n,u,l,a){const c=new Int16Array(n.buffer),y=c.length/a,S=u.createBuffer(a,y,l);for(let m=0;m<a;m++){const I=S.getChannelData(m);for(let N=0;N<y;N++)I[N]=c[N*a+m]/32768}return S}function pe(n){const u=new ArrayBuffer(n.length*2),l=new DataView(u);for(let a=0;a<n.length;a++){const c=Math.max(-1,Math.min(1,n[a]));l.setInt16(a*2,c<0?c*32768:c*32767,!0)}return u}const be=n=>n.startsWith("wss://")||n.startsWith("ws://")?n:n.startsWith("https://")?n.replace("https://","wss://"):n.startsWith("http://")?n.replace("http://","ws://"):n,ce=(n,u)=>{const l=n.includes("?")?"&":"?",a=new URLSearchParams(u).toString();return`${n}${l}${a}`},ge=n=>{const u="wss://voice-proxy-417768250731.us-central1.run.app";if(u.trim())return ce(be(u.trim()),{token:n});const l=window.location.protocol==="https:"?"wss":"ws";return ce(`${l}://${window.location.host}/voice`,{token:n})},we=({onConnectionStateChange:n,onError:u,persona:l="alicia",accessCode:a,memoryConsent:c,onCallProche:y})=>{const[S,m]=t.useState(!1),[I,N]=t.useState(!1),v=t.useRef(!1),[T,Q]=t.useState(0),k=t.useRef(n),h=t.useRef(u),U=t.useRef(y);t.useEffect(()=>{k.current=n,h.current=u,U.current=y},[n,u,y]);const d=t.useRef(null),x=t.useRef(null),b=t.useRef(null),j=t.useRef(null),D=t.useRef(null),R=t.useRef(null),f=t.useRef(null),M=t.useRef(new Set),F=t.useRef(0),J=t.useRef(!1),p=t.useRef(null),L=t.useRef(null),$=t.useRef(null),A=t.useRef(!1),W=t.useCallback(async()=>{if(!a||!c)return;const r=String(a).trim(),o=sessionStorage.getItem("mvp_first_name")||"";if(r){console.log("üíæ Fallback: Saving default memory entry...");try{await fetch("/api/memory/set",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({accessCode:r,summary:"Conversation termin√©e par l'utilisateur.",profileName:o,persona:l})}),console.log("‚úÖ Fallback save completed")}catch(s){console.error("‚ùå Fallback save error:",s)}}},[a,c,l]),G=t.useCallback(()=>{var r;d.current&&(d.current.close(),d.current=null),R.current&&(cancelAnimationFrame(R.current),R.current=null),j.current&&(j.current.disconnect(),j.current=null),f.current&&(f.current.getTracks().forEach(o=>o.stop()),f.current=null),M.current.forEach(o=>{try{o.stop(),o.disconnect()}catch{}}),M.current.clear(),x.current&&x.current.state!=="closed"&&(x.current.close().catch(()=>{}),x.current=null),b.current&&b.current.state!=="closed"&&(b.current.close().catch(()=>{}),b.current=null),(r=k.current)==null||r.call(k,!1)},[]),C=t.useCallback(async(r=!1)=>{if(r&&d.current&&d.current.readyState===d.current.OPEN&&v.current){if(console.log("üõë Requesting graceful shutdown..."),v.current=!1,f.current&&f.current.getTracks().forEach(s=>s.enabled=!1),j.current)try{j.current.disconnect()}catch{}J.current=!1,d.current.send(JSON.stringify({type:"text",data:"Je dois y aller. Fais le r√©sum√© et termine la conversation."})),await new Promise(s=>setTimeout(s,8e3)),J.current||(console.log("‚ö†Ô∏è Tool call not received after 4s, using fallback save"),await W())}else!J.current&&v.current&&(console.log("‚ö†Ô∏è Force stop while streaming, attempting fallback save"),await W());v.current=!1,m(!1),N(!1),d.current&&d.current.readyState===d.current.OPEN&&d.current.send(JSON.stringify({type:"stop"})),p.current&&window.clearTimeout(p.current),$.current&&(window.clearTimeout($.current),$.current=null),p.current=window.setTimeout(()=>{G(),p.current=null},1e3)},[W,G]),P=t.useCallback(()=>{var r;m(!1),v.current=!1,(r=k.current)==null||r.call(k,!1)},[]),Z=t.useCallback(()=>{if(D.current&&v.current){const r=new Uint8Array(D.current.frequencyBinCount);D.current.getByteTimeDomainData(r);let o=0;for(const s of r){const i=s/128-1;o+=i*i}Q(Math.sqrt(o/r.length))}else Q(0);R.current=requestAnimationFrame(Z)},[]),H=t.useCallback(r=>{d.current&&d.current.readyState===d.current.OPEN&&d.current.send(JSON.stringify({type:"text",data:r}))},[]),X=t.useCallback(async r=>{var o,s,i,q,te;if(r.type==="state"){N(!1),m(r.connected),v.current=r.connected,(o=k.current)==null||o.call(k,r.connected);return}if(r.type==="error"){(s=h.current)==null||s.call(h,r.message);return}if(r.type==="interrupted"){M.current.forEach(g=>{try{g.stop(),g.disconnect()}catch{}}),M.current.clear(),F.current=0;return}if(r.type==="audio"&&b.current){try{F.current=Math.max(F.current,b.current.currentTime);const g=await xe(he(r.data),b.current,24e3,1),w=b.current.createBufferSource();w.buffer=g,w.connect(b.current.destination),w.addEventListener("ended",()=>M.current.delete(w)),w.start(F.current),F.current+=g.duration,M.current.add(w)}catch{}return}if(r.type==="functionCall"){if(r.name==="appeler_proche"){const g=(i=r.args)==null?void 0:i.nom;g&&((q=U.current)==null||q.call(U,g));return}if(r.name==="sauvegarder_et_quitter"||r.name==="fin_de_conversation"){console.log("üîß Tool Call Received: "+r.name,r.args),J.current=!0;const g=(te=r.args)==null?void 0:te.resume;if(g&&a&&c){console.log("üíæ Attempting to save memory to Firestore...");const w=String(a).trim(),Y=sessionStorage.getItem("mvp_first_name")||"";w&&fetch("/api/memory/set",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({accessCode:w,summary:g,profileName:Y,persona:l})}).then(B=>{console.log("‚úÖ Save response status:",B.status),B.ok||console.error("‚ùå Save failed")}).catch(B=>console.error("‚ùå Save error:",B))}else console.warn("‚ö†Ô∏è Memory not saved: Missing code or consent",{accessCode:a,memoryConsent:c});A.current?window.dispatchEvent(new CustomEvent("session-refreshing")):window.dispatchEvent(new CustomEvent("session-closing")),L.current&&window.clearTimeout(L.current),L.current=window.setTimeout(()=>{const w=A.current;C(),L.current=null,w&&setTimeout(()=>{v.current||I||K()},1e3)},6e3)}}},[C,a,c,l]),K=t.useCallback(async()=>{var r;if(!(v.current||I)){A.current=!1,p.current&&(window.clearTimeout(p.current),G(),p.current=null),N(!0),J.current=!1,F.current=0,L.current&&(window.clearTimeout(L.current),L.current=null);try{let o="",s="";const i=String(a||"").trim();if(c){if(!i)throw new Error("Code d'acc√®s requis pour charger la m√©moire.");try{const E=await fetch("/api/memory/get",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({accessCode:i})});if(E.ok){const O=await E.json();s=String(O.profileName||"");const ee=(Array.isArray(O.entries)?O.entries:[]).filter(z=>z&&typeof z.summary=="string"&&z.summary.trim()).map(z=>{const ae=z.createdAt?new Date(z.createdAt).toLocaleDateString("fr-CA"):"";return`- ${ae?`[${ae}] `:""}${String(z.summary).trim()}`});ee.length&&(o=`Historique des conversations (r√©cent):
${ee.join(`
`)}`)}}catch{}}o=`${`Pr√©nom de l'utilisateur: ${sessionStorage.getItem("mvp_first_name")||""||s||"Utilisateur"}.`}
${o}`.trim(),console.log("üì° Initializing Voice Session...",{persona:l,accessCode:i,hasMemory:!!o,memoryLength:o.length});const g=window.AudioContext||window.webkitAudioContext;x.current=new g({sampleRate:16e3}),b.current=new g({sampleRate:24e3}),await x.current.resume(),await b.current.resume();const w=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0},video:!1});f.current=w;const Y=await fetch("/api/voice-token",{method:"GET"});if(!Y.ok)throw new Error("Impossible de s√©curiser la session.");const B=await Y.json(),re=String(B.token||"");if(!re)throw new Error("Token invalide.");const se=ge(re);console.log("üîå Connecting to WebSocket:",se);const _=new WebSocket(se);d.current=_,_.onmessage=async E=>{console.log("üì© Received WebSocket message:",E.data.toString().substring(0,100));try{const O=JSON.parse(E.data);await X(O)}catch(O){console.error("‚ùå Failed to parse message:",O)}},_.onopen=()=>{console.log("‚úÖ WebSocket opened, sending start message..."),_.send(JSON.stringify({type:"start",persona:l,memory:o})),$.current&&window.clearTimeout($.current),$.current=window.setTimeout(async()=>{console.log("üîÑ Session limit approaching, refreshing..."),A.current=!0,await C(!0)},54e4);const E=x.current.createMediaStreamSource(w);D.current=x.current.createAnalyser(),D.current.fftSize=256,E.connect(D.current),j.current=x.current.createScriptProcessor(256,1,1),j.current.onaudioprocess=ne=>{if(!v.current||_.readyState!==_.OPEN)return;const ee=ne.inputBuffer.getChannelData(0),z=pe(ee);_.send(z)},E.connect(j.current);const O=x.current.createGain();O.gain.value=0,j.current.connect(O),O.connect(x.current.destination),Z()},_.onerror=()=>{var E;(E=h.current)==null||E.call(h,"Connexion impossible. Veuillez r√©essayer.")},_.onclose=()=>{C()}}catch(o){(r=h.current)==null||r.call(h,(o==null?void 0:o.message)||"Impossible d'initialiser le micro."),C()}}},[X,I,l,C,a,c]);return t.useEffect(()=>()=>{C()},[C]),{isStreaming:S,isConnecting:I,startSession:K,stopSession:C,forceStopUI:P,sendText:H,volumeLevel:T}},Se=({onClose:n,persona:u,accessCode:l,memoryConsent:a,onStartCall:c})=>{const[y,S]=V.useState(!1),m=V.useRef(!1),[I,N]=t.useState(null),[v,T]=t.useState(null),[Q,k]=t.useState(!1),[h,U]=t.useState(""),[d,x]=t.useState(""),[b,j]=t.useState(!1),[D,R]=t.useState(!1),f=V.useRef(null),M=V.useRef(void 0),F=V.useCallback(s=>{N(s)},[]),J=V.useCallback(s=>{s?(m.current=!1,S(!1),N(null),k(!1),R(!1)):m.current||S(!1)},[]),{isStreaming:p,isConnecting:L,startSession:$,stopSession:A,volumeLevel:W}=we({onError:F,onConnectionStateChange:J,persona:u,accessCode:l,memoryConsent:a,onCallProche:s=>{var i;return(i=M.current)==null?void 0:i.call(M,s)}});t.useEffect(()=>{M.current=s=>{console.log("üìû IA requested call for:",s);const i=s.replace(/\s+/g,"_").toLowerCase(),q=`AliciaZakaria_${l}_${i}`;A(),c==null||c(q,s)}},[l,A,c]);const G=async()=>{p&&!y?(m.current=!0,S(!0),f.current&&window.clearTimeout(f.current),await A(!0),R(!0),S(!1),m.current=!1,T("Session termin√©e.")):p||(A(),R(!0))};t.useEffect(()=>{const s=()=>{m.current=!0,S(!0),R(!0),f.current&&window.clearTimeout(f.current),f.current=window.setTimeout(()=>{S(!1),T("Session termin√©e."),m.current=!1},2500)},i=()=>{T("Optimisation de la connexion..."),f.current&&window.clearTimeout(f.current),f.current=window.setTimeout(()=>{T(null)},2500)};return window.addEventListener("session-closing",s),window.addEventListener("session-refreshing",i),$(),()=>{A(),window.removeEventListener("session-closing",s),window.removeEventListener("session-refreshing",i),f.current&&window.clearTimeout(f.current)}},[]);const C=async s=>{if(s.preventDefault(),!!h.trim()){j(!0),x("");try{const i=await fetch("/api/search",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:h})});if(!i.ok)throw new Error("Search failed");const q=await i.json();x(q.text||"Je n'ai pas trouv√© de r√©ponse, d√©sol√©.")}catch{x("Une erreur est survenue lors de la recherche. Veuillez r√©essayer.")}finally{j(!1)}}},P=u==="alicia",Z=P?"bg-teal-100 dark:bg-teal-900 text-teal-800 dark:text-teal-200":"bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200",H=P?"bg-teal-400":"bg-blue-400",X=P?"bg-gradient-to-br from-teal-400 to-emerald-500":"bg-gradient-to-br from-blue-400 to-indigo-500",K=P?"bg-teal-600 dark:bg-teal-700 text-white hover:bg-teal-700 dark:hover:bg-teal-600":"bg-blue-600 dark:bg-blue-700 text-white hover:bg-blue-700 dark:hover:bg-blue-600",r=async()=>{const s=l.trim();if(s){T(null);try{if(!(await fetch("/api/memory/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({accessCode:s})})).ok)throw new Error("delete failed");T("M√©moire effac√©e.")}catch{T("Impossible d'effacer la m√©moire.")}}},o=y?"Fermeture de la session...":p?"Parlez-moi de votre journ√©e, ou demandez-moi une histoire.":L?"Connexion en cours...":D?"Session en pause.":"Initialisation en cours...";return e.jsxs("div",{className:"h-full flex flex-col items-center justify-between py-8 max-w-2xl mx-auto",children:[e.jsxs("div",{className:"w-full flex justify-between items-center px-4",children:[e.jsxs("div",{className:`${Z} px-4 py-2 rounded-full font-medium text-lg transition-colors`,children:["En ligne avec ",P?"Alicia":"Zakaria"]}),e.jsx("button",{onClick:n,className:"bg-red-100 dark:bg-red-900/50 p-4 rounded-full text-red-700 dark:text-red-300 hover:bg-red-200 dark:hover:bg-red-900 transition-colors",children:e.jsx(oe,{className:"w-8 h-8"})})]}),e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center gap-8 w-full",children:[I&&e.jsx("div",{className:"w-full px-4",children:e.jsxs("div",{className:"bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-800 rounded-2xl p-4 text-amber-900 dark:text-amber-100",children:[e.jsx("p",{className:"font-bold mb-2",children:"Microphone indisponible"}),e.jsx("p",{className:"text-sm mb-4",children:I}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>$(),className:"px-4 py-2 rounded-xl bg-amber-600 text-white font-bold hover:bg-amber-700 transition-colors",children:"R√©essayer"}),e.jsx("button",{onClick:()=>k(!0),className:"px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 font-bold hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors",children:"Mode texte"})]})]})}),v&&e.jsx("div",{className:"w-full px-4",children:e.jsxs("div",{className:"bg-emerald-50 dark:bg-emerald-900/30 border border-emerald-200 dark:border-emerald-800 rounded-2xl p-4 text-emerald-900 dark:text-emerald-100 flex justify-between items-center",children:[e.jsx("p",{className:"text-sm",children:v}),e.jsx("button",{onClick:()=>T(null),className:"text-emerald-500 hover:text-emerald-600",children:e.jsx(oe,{className:"w-4 h-4"})})]})}),Q&&e.jsx("div",{className:"w-full px-4",children:e.jsxs("div",{className:"bg-white dark:bg-slate-900 p-6 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-800 space-y-4",children:[e.jsx("h3",{className:"text-xl font-bold text-slate-800 dark:text-slate-100",children:"Mode texte"}),e.jsxs("form",{onSubmit:C,className:"flex gap-3",children:[e.jsx("input",{type:"text",value:h,onChange:s=>U(s.target.value),placeholder:"√âcrivez votre message...",className:"flex-1 bg-slate-50 dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 rounded-2xl px-4 py-3 text-lg text-slate-900 dark:text-slate-100 focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:focus:ring-blue-900/50 outline-none transition-all placeholder:text-slate-400 dark:placeholder:text-slate-500"}),e.jsx("button",{type:"submit",disabled:b||!h.trim(),className:"bg-blue-600 dark:bg-blue-700 text-white px-5 rounded-xl font-bold hover:bg-blue-700 dark:hover:bg-blue-600 disabled:bg-slate-300 dark:disabled:bg-slate-700 disabled:cursor-not-allowed transition-colors",children:"Envoyer"})]}),b&&e.jsx("p",{className:"text-slate-500",children:"Recherche en cours..."}),d&&e.jsx("p",{className:"text-slate-800 dark:text-slate-200 whitespace-pre-wrap",children:d})]})}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:`absolute inset-0 ${H} rounded-full opacity-20 transition-all duration-75`,style:{transform:`scale(${1+W*3})`}}),e.jsx("div",{className:`absolute inset-0 ${H} rounded-full opacity-20 transition-all duration-100 delay-75`,style:{transform:`scale(${1+W*4})`}}),e.jsx("div",{className:`w-64 h-64 ${X} rounded-full flex items-center justify-center shadow-xl relative z-10 border-8 border-white dark:border-slate-800 transition-colors`,children:p?e.jsx(de,{className:"w-24 h-24 text-white animate-pulse"}):e.jsx("div",{className:"text-white text-6xl font-bold",children:P?"A":"Z"})})]}),e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("h2",{className:"text-3xl font-bold text-slate-800 dark:text-white",children:y?"√Ä la prochaine !":p?"Je vous √©coute...":"En attente..."}),e.jsx("p",{className:"text-xl text-slate-500 dark:text-slate-400",children:o})]})]}),e.jsxs("div",{className:"w-full px-4 pb-8",children:[e.jsxs("div",{className:"flex flex-col items-center gap-6",children:[e.jsxs("div",{className:"flex justify-center gap-6 flex-wrap",children:[p&&e.jsxs("button",{onClick:G,disabled:y,className:"flex items-center gap-4 px-12 py-6 rounded-full text-2xl font-bold shadow-lg transition-all transform active:scale-95 bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-200 border-2 border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 disabled:opacity-50",children:[e.jsx(me,{className:"w-8 h-8"}),y?"Fermeture...":"Arr√™ter"]}),!p&&D&&e.jsxs("button",{onClick:()=>{N(null),T(null),setCurrentSubtitle(""),R(!1),$()},className:`flex items-center gap-4 px-12 py-6 rounded-full text-2xl font-bold shadow-lg transition-all transform active:scale-95 ${K}`,children:[e.jsx(ie,{className:"w-8 h-8"}),"Reprendre"]})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{onClick:r,className:"flex items-center gap-3 px-6 py-4 rounded-full text-lg font-bold shadow-sm transition-all transform active:scale-95 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 border border-slate-200 dark:border-slate-700 hover:bg-slate-200 dark:hover:bg-slate-700",children:"Effacer la m√©moire"}),y&&e.jsx("button",{onClick:()=>{A(),R(!0),S(!1)},className:"text-slate-400 hover:text-red-500 text-sm font-medium underline",children:"Forcer l'arr√™t (sans sauvegarde)"})]})]}),!a&&e.jsx("p",{className:"mt-4 text-center text-sm text-slate-500 dark:text-slate-400",children:"La m√©moire est d√©sactiv√©e. Activez-la depuis l‚Äô√©cran d‚Äôacc√®s si vous le souhaitez."})]})]})};export{Se as VoiceChat};
